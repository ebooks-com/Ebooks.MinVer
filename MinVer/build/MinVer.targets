<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <Import Project="MinVer.Options.targets" />

  <PropertyGroup>
    <MSBuildAllProjects Condition="'$(MSBuildAssemblyVersion)' == '' Or '$(MSBuildAssemblyVersion)' &lt; '16.0'">$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
    <GetPackageVersionDependsOn>$(GetPackageVersionDependsOn);MinVer</GetPackageVersionDependsOn>
  </PropertyGroup>

  <Target Name="MinVer_GetVersion" Condition="'$(MinVerVersionOverride)' == ''">
    <ItemGroup>
      <MinVerInputs Include="--build-metadata &quot;$(MinVerBuildMetadata)&quot;" Condition="'$(MinVerBuildMetadata)' != ''" />
      <MinVerInputs Include="--major-minor &quot;$(MinVerMajorMinor)&quot;" Condition="'$(MinVerMajorMinor)' != ''" />
      <MinVerInputs Include="--repo &quot;$(MSBuildProjectDirectory)&quot;" Condition="'$(MSBuildProjectDirectory)' != ''" />
      <MinVerInputs Include="--tag-prefix &quot;$(MinVerTagPrefix)&quot;" Condition="'$(MinVerTagPrefix)' != ''" />
      <MinVerInputs Include="--verbosity &quot;$(MinVerVerbosity)&quot;" Condition="'$(MinVerVerbosity)' != ''" />
    </ItemGroup>
    <Exec Command="dotnet &quot;$(MSBuildThisFileDirectory)../minver-tasks/MinVer.Tasks.dll&quot; @(MinVerInputs->'%(Identity)', ' ')" ConsoleToMSBuild="true">
      <Output TaskParameter="ConsoleOutput" ItemName="MinVerConsoleOutput" />
    </Exec>
    <ItemGroup>
      <MinVerOutput Include="@(MinVerConsoleOutput)" Condition="'$([System.String]::new(`%(Identity)`).StartsWith(`MinVer:`))' != 'true'" />
    </ItemGroup>
    <PropertyGroup>
      <MinVerVersion>@(MinVerOutput)</MinVerVersion>
    </PropertyGroup>
  </Target>

  <Target Name="MinVer_OverrideVersion" BeforeTargets="MinVer_GetVersion" Condition="'$(MinVerVersionOverride)' != ''">
    <Message Text="MinVer: Using version override $(MinVerVersionOverride)." Importance="high" />
    <PropertyGroup>
      <MinVerVersion>$(MinVerVersionOverride)</MinVerVersion>
    </PropertyGroup>
  </Target>

  <Target Name="MinVer" BeforeTargets="CoreCompile;GenerateNuspec" DependsOnTargets="MinVer_GetOptions;MinVer_GetVersion" Condition="'$(UsingMicrosoftNETSdk)' == 'true' And '$(DesignTimeBuild)' != 'true'">
    <PropertyGroup>
      <Version>$(MinVerVersion)</Version>
      <PackageVersion>$(MinVerVersion)</PackageVersion>
    </PropertyGroup>
  </Target>

  <Target Name="MinVer_EnsureSdk" BeforeTargets="MinVer" Condition="'$(DesignTimeBuild)' != 'true'">
    <Error Condition="'$(UsingMicrosoftNETSdk)' != 'true'" Code="MINVER0001" Text="MinVer only works in SDK-style projects." />
  </Target>

</Project>
