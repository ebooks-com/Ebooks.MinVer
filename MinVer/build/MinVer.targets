<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <Import Project="MinVer.Options.targets" />

  <PropertyGroup>
    <MSBuildAllProjects Condition="'$(MSBuildAssemblyVersion)' == '' Or '$(MSBuildAssemblyVersion)' &lt; '16.0'">$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
    <GetPackageVersionDependsOn>$(GetPackageVersionDependsOn);MinVer</GetPackageVersionDependsOn>
  </PropertyGroup>

  <Target Name="MinVer_GetVersion" Condition="'$(MinVerVersionOverride)' == ''">
    <ItemGroup>
      <MinVerOptions Include="--build-metadata &quot;$(MinVerBuildMetadata)&quot;" />
      <MinVerOptions Include="--major-minor &quot;$(MinVerMajorMinor)&quot;" />
      <MinVerOptions Include="--path &quot;$(MSBuildProjectDirectory)&quot;" />
      <MinVerOptions Include="--tag-prefix &quot;$(MinVerTagPrefix)&quot;" />
      <MinVerOptions Include="--verbose" Condition="'$(MinVerVerbose)' == 'true'" />
    </ItemGroup>
    <Exec Command="dotnet &quot;$(MSBuildThisFileDirectory)../MinVer/MinVer.Cli.dll&quot; @(MinVerOptions->'%(Identity)', ' ')" ConsoleToMSBuild="true">
      <Output TaskParameter="ConsoleOutput" ItemName="MinVerOutput" />
    </Exec>
    <ItemGroup>
      <MinVerStdout Include="@(MinVerOutput)" Condition="'$([System.String]::new(`%(Identity)`).StartsWith(`MinVer:`))' != 'true'" />
    </ItemGroup>
    <PropertyGroup>
      <MinVerVersion>@(MinVerStdout)</MinVerVersion>
    </PropertyGroup>
  </Target>

  <Target Name="MinVer_OverrideVersion" BeforeTargets="MinVer_GetVersion" Condition="'$(MinVerVersionOverride)' != ''">
    <Message Text="MinVer: Using version override $(MinVerVersionOverride)." Importance="high" />
    <PropertyGroup>
      <MinVerVersion>$(MinVerVersionOverride)</MinVerVersion>
    </PropertyGroup>
  </Target>

  <Target Name="MinVer" BeforeTargets="CoreCompile;GenerateNuspec" DependsOnTargets="MinVer_GetOptions;MinVer_GetVersion" Condition="'$(UsingMicrosoftNETSdk)' == 'true' And '$(DesignTimeBuild)' != 'true'">
    <PropertyGroup>
      <Version>$(MinVerVersion)</Version>
      <PackageVersion>$(MinVerVersion)</PackageVersion>
    </PropertyGroup>
  </Target>

  <Target Name="MinVer_EnsureSdk" BeforeTargets="MinVer" Condition="'$(DesignTimeBuild)' != 'true'">
    <Error Condition="'$(UsingMicrosoftNETSdk)' != 'true'" Code="MINVER0002" Text="MinVer only works in SDK-style projects." />
  </Target>

</Project>
